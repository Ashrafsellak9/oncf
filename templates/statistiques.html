{% extends "base.html" %}

{% block title %}ONCF GIS - Statistiques{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-0">
                <i class="fas fa-chart-bar me-2 text-primary"></i>
                Statistiques du Réseau Ferroviaire
            </h1>
            <p class="text-muted">Analyse détaillée des données du réseau ONCF</p>
        </div>
    </div>

    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label for="periodSelect" class="form-label">Période</label>
                            <select class="form-select" id="periodSelect">
                                <option value="all">Toutes les périodes</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="regionSelect" class="form-label">Région</label>
                            <select class="form-select" id="regionSelect">
                                <option value="">Toutes les régions</option>
                                <option value="casablanca">Casablanca-Settat</option>
                                <option value="rabat">Rabat-Salé-Kénitra</option>
                                <option value="fes">Fès-Meknès</option>
                                <option value="marrakech">Marrakech-Safi</option>
                                <option value="tanger">Tanger-Tétouan-Al Hoceïma</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="typeSelect" class="form-label">Type de Données</label>
                            <select class="form-select" id="typeSelect">
                                <option value="gares">Gares</option>
                                <option value="arcs">Voies</option>
                                <option value="trafic">Trafic</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="updateCharts()">
                                <i class="fas fa-sync-alt me-2"></i>Actualiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dashboard-card text-center">
                <div class="stat-icon bg-primary bg-opacity-10 rounded-circle mx-auto mb-3">
                    <i class="fas fa-building fa-2x text-primary"></i>
                </div>
                <h3 class="mb-1" id="totalGares">-</h3>
                <p class="text-muted mb-0">Total Gares</p>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dashboard-card text-center">
                <div class="stat-icon bg-success bg-opacity-10 rounded-circle mx-auto mb-3">
                    <i class="fas fa-route fa-2x text-success"></i>
                </div>
                <h3 class="mb-1" id="totalArcs">-</h3>
                <p class="text-muted mb-0">Sections de Voie</p>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dashboard-card text-center">
                <div class="stat-icon bg-info bg-opacity-10 rounded-circle mx-auto mb-3">
                    <i class="fas fa-map-marked-alt fa-2x text-info"></i>
                </div>
                <h3 class="mb-1" id="totalAxes">-</h3>
                <p class="text-muted mb-0">Axes Ferroviaires</p>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="dashboard-card text-center">
                <div class="stat-icon bg-warning bg-opacity-10 rounded-circle mx-auto mb-3">
                    <i class="fas fa-city fa-2x text-warning"></i>
                </div>
                <h3 class="mb-1" id="totalVilles">-</h3>
                <p class="text-muted mb-0">Villes Desservies</p>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h3 class="mb-3">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                    Répartition des Gares par Type
                </h3>
                <canvas id="garesTypeChart" height="300"></canvas>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h3 class="mb-3">
                    <i class="fas fa-chart-bar me-2 text-success"></i>
                    Répartition par Axe Ferroviaire
                </h3>
                <canvas id="axesChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <h3 class="mb-3">
                    <i class="fas fa-chart-line me-2 text-info"></i>
                    Évolution du Réseau
                </h3>
                <canvas id="timelineChart" height="300"></canvas>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <h3 class="mb-3">
                    <i class="fas fa-chart-doughnut me-2 text-warning"></i>
                    État des Gares
                </h3>
                <canvas id="etatChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Tableaux Détaillés -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h3 class="mb-3">
                    <i class="fas fa-table me-2 text-primary"></i>
                    Top 10 des Axes par Nombre de Gares
                </h3>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Axe</th>
                                <th>Nombre de Gares</th>
                                <th>Pourcentage</th>
                            </tr>
                        </thead>
                        <tbody id="topAxesTable">
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="loading"></div>
                                    Chargement...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="dashboard-card">
                <h3 class="mb-3">
                    <i class="fas fa-list me-2 text-success"></i>
                    Répartition par Type de Gare
                </h3>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                            </tr>
                        </thead>
                        <tbody id="typeGaresTable">
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="loading"></div>
                                    Chargement...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Métriques Avancées -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h3 class="mb-3">
                    <i class="fas fa-calculator me-2 text-info"></i>
                    Métriques Avancées
                </h3>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center p-3 border rounded">
                            <div class="metric-value text-primary" id="densiteGares">-</div>
                            <div class="metric-label">Densité de Gares</div>
                            <small class="text-muted">gares/1000 km²</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center p-3 border rounded">
                            <div class="metric-value text-success" id="longueurReseau">-</div>
                            <div class="metric-label">Longueur du Réseau</div>
                            <small class="text-muted">km</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center p-3 border rounded">
                            <div class="metric-value text-warning" id="couverturePop">-</div>
                            <div class="metric-label">Couverture Population</div>
                            <small class="text-muted">%</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center p-3 border rounded">
                            <div class="metric-value text-info" id="efficaciteReseau">-</div>
                            <div class="metric-label">Efficacité Réseau</div>
                            <small class="text-muted">score/100</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.metric-card {
    background: white;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.chart-container canvas {
    max-height: 400px;
}

.table th {
    font-weight: 600;
    color: var(--primary-color);
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    border-radius: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales pour les graphiques
let garesTypeChart, axesChart, timelineChart, etatChart;

// Initialisation des graphiques
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    initializeCharts();
});

// Charger les statistiques
function loadStatistics() {
    fetch('/api/statistiques')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatistics(data.data);
                updateTables(data.data);
                updateMetrics(data.data);
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des statistiques:', error);
            showNotification('Erreur lors du chargement des données', 'error');
        });
}

// Mettre à jour les statistiques principales
function updateStatistics(stats) {
    document.getElementById('totalGares').textContent = stats.gares.total;
    document.getElementById('totalArcs').textContent = stats.arcs.total;
    document.getElementById('totalAxes').textContent = stats.gares.par_axe.length;
    
    // Compter les villes uniques
    const villes = new Set();
    stats.gares.par_axe.forEach(axe => {
        if (axe.axe) villes.add(axe.axe);
    });
    document.getElementById('totalVilles').textContent = villes.size;
}

// Initialiser les graphiques
function initializeCharts() {
    createGaresTypeChart();
    createAxesChart();
    createTimelineChart();
    createEtatChart();
}

// Créer le graphique des types de gares
function createGaresTypeChart() {
    const ctx = document.getElementById('garesTypeChart');
    if (!ctx) return;

    fetch('/api/statistiques')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const chartData = data.data.gares.par_type;
                
                garesTypeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.map(item => item.type || 'Non défini'),
                        datasets: [{
                            data: chartData.map(item => item.count),
                            backgroundColor: [
                                '#0d6efd',
                                '#198754',
                                '#ffc107',
                                '#dc3545',
                                '#6c757d',
                                '#fd7e14',
                                '#6f42c1',
                                '#20c997'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
}

// Créer le graphique des axes
function createAxesChart() {
    const ctx = document.getElementById('axesChart');
    if (!ctx) return;

    fetch('/api/statistiques')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const chartData = data.data.gares.par_axe.slice(0, 10); // Top 10
                
                axesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(item => item.axe || 'Non défini'),
                        datasets: [{
                            label: 'Nombre de Gares',
                            data: chartData.map(item => item.count),
                            backgroundColor: 'rgba(13, 110, 253, 0.8)',
                            borderColor: '#0d6efd',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        });
}

// Créer le graphique temporel
function createTimelineChart() {
    const ctx = document.getElementById('timelineChart');
    if (!ctx) return;

    // Données d'exemple pour l'évolution
    const data = {
        labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
        datasets: [{
            label: 'Nombre de Gares',
            data: [120, 125, 130, 135, 140, 145],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Sections de Voie',
            data: [200, 210, 220, 230, 240, 250],
            borderColor: '#198754',
            backgroundColor: 'rgba(25, 135, 84, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };

    timelineChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

// Créer le graphique d'état
function createEtatChart() {
    const ctx = document.getElementById('etatChart');
    if (!ctx) return;

    // Données d'exemple pour l'état des gares
    const data = {
        labels: ['Actives', 'Passives', 'En Maintenance'],
        datasets: [{
            data: [85, 10, 5],
            backgroundColor: [
                '#198754',
                '#6c757d',
                '#ffc107'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };

    etatChart = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Mettre à jour les tableaux
function updateTables(stats) {
    updateTopAxesTable(stats.gares.par_axe);
    updateTypeGaresTable(stats.gares.par_type);
}

// Mettre à jour le tableau des axes
function updateTopAxesTable(axesData) {
    const tableBody = document.getElementById('topAxesTable');
    if (!tableBody) return;

    const total = axesData.reduce((sum, item) => sum + item.count, 0);
    const topAxes = axesData.slice(0, 10);

    tableBody.innerHTML = '';
    topAxes.forEach(axe => {
        const percentage = ((axe.count / total) * 100).toFixed(1);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${axe.axe || 'Non défini'}</strong></td>
            <td>${axe.count}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                    </div>
                    <small>${percentage}%</small>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Mettre à jour le tableau des types
function updateTypeGaresTable(typeData) {
    const tableBody = document.getElementById('typeGaresTable');
    if (!tableBody) return;

    const total = typeData.reduce((sum, item) => sum + item.count, 0);

    tableBody.innerHTML = '';
    typeData.forEach(type => {
        const percentage = ((type.count / total) * 100).toFixed(1);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${type.type || 'Non défini'}</strong></td>
            <td>${type.count}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${percentage}%"></div>
                    </div>
                    <small>${percentage}%</small>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Mettre à jour les métriques avancées
function updateMetrics(stats) {
    // Calculs d'exemple pour les métriques
    const totalGares = stats.gares.total;
    const totalArcs = stats.arcs.total;
    
    // Densité de gares (exemple)
    const densite = (totalGares / 446.5).toFixed(1); // 446.5 = superficie Maroc en milliers km²
    document.getElementById('densiteGares').textContent = densite;
    
    // Longueur du réseau (estimation basée sur les arcs)
    const longueur = (totalArcs * 15).toFixed(0); // Estimation moyenne de 15km par section
    document.getElementById('longueurReseau').textContent = longueur;
    
    // Couverture population (exemple)
    const couverture = 75; // Exemple
    document.getElementById('couverturePop').textContent = couverture;
    
    // Efficacité réseau (score calculé)
    const efficacite = Math.min(100, Math.round((totalGares / 200) * 100));
    document.getElementById('efficaciteReseau').textContent = efficacite;
}

// Fonction pour actualiser les graphiques
function updateCharts() {
    // Recharger les données et mettre à jour les graphiques
    loadStatistics();
    
    // Mettre à jour les graphiques existants
    if (garesTypeChart) garesTypeChart.destroy();
    if (axesChart) axesChart.destroy();
    if (timelineChart) timelineChart.destroy();
    if (etatChart) etatChart.destroy();
    
    // Recréer les graphiques
    setTimeout(() => {
        initializeCharts();
    }, 500);
}

// Fonction pour afficher les notifications
function showNotification(message, type = 'info') {
    if (window.oncfGIS && window.oncfGIS.showNotification) {
        window.oncfGIS.showNotification(message, type);
    } else {
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}
</script>
{% endblock %} 